@{
    ViewData["Title"] = "People";
    // ViewData["People"] expected to be IEnumerable<dynamic> (Id, FirstName, LastName, ClientName, etc.)
    // TODO: Change the view to a strongly-typed view mode
    bool showDeleted = Convert.ToBoolean(ViewData["ShowDeleted"]);
    var people = (ViewData["People"] as IEnumerable<dynamic>) ?? Enumerable.Empty<dynamic>();
}
@Html.AntiForgeryToken()

<h1>All People</h1>

<p>
    <a asp-action="Create" class="btn btn-outline-indigo btn-lg px-4">+ Create New</a>
</p>

@if (people == null || !people.Any())
{
    <div class="alert alert-info" role="alert">
        No people found. Click "Create New" to add a person.
    </div>
}
else
{
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Email</th>
                <th>Street</th>
                <th>City</th>
                <th>State</th>
                <th>Zip</th>
                <th>Client</th>
                @if (showDeleted)
                {
                    <th>Is Deleted</th>
                }
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in people)
            {
                <tr>
                    <td>@item.FirstName</td>
                    <td>@item.LastName</td>
                    <td>@item.EmailAddress</td>
                    <td>@item.StreetAddress</td>
                    <td>@item.City</td>
                    <td>@item.State</td>
                    <td>@item.ZipCode</td>
                    <td>@item.ClientName</td>
                    @if (showDeleted)
                    {
                        <td>@item.IsDeleted</td>
                    }
                    <td>
                        <div class="btn-group" role="group" aria-label="Actions">
                            <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-pencil"></i> Edit
                            </a>
                            <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-sm btn-outline-info">
                                <i class="bi bi-eye"></i> Details
                            </a>
                            <a href="javascript:void(0)"
                               class="btn btn-sm btn-outline-danger delete-btn"
                               data-id="@item.Id"
                               data-name="@item.FirstName @item.LastName">
                                <i class="bi bi-trash"></i> Delete
                            </a>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}


@section Scripts {
    <script>
        $(document).ready(function() {
            let deleteId = null;

            $(".delete-btn").click(function () {
                deleteId = $(this).data("id");
                const name = $(this).data("name");
                $("#deleteModal .modal-body").text(`Are you sure you want to delete "${name}"?`);
                $("#deleteModal").modal("show");
            });

            $("#confirmDeleteBtn").click(function () {
                if (!deleteId) return;

                $.ajax({
                    url: `/People/Delete/${deleteId}`,
                    type: "POST",
                    data: { __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val() },
                    success: function () {
                        $("#deleteModal").modal("hide");

                        showVueToast("Person deleted successfully!", "danger");

                        $(`a.delete-btn[data-id='${deleteId}']`).closest("tr").fadeOut(500, function() {
                            $(this).remove();

                            // Check if table is empty now
                            if ($("table tbody tr").length === 0) {
                                // Find the main container so we can put the alert in the right place
                                const container = $("table").closest(".container, .container-fluid, main, section");

                                $("table").remove();

                                container.append(`
                                    <div class="alert alert-info mt-4 text-center" role="alert">
                                        No people found. Click <strong>"Create New"</strong> to add a person.
                                    </div>
                                `);
                            }
                        });
                    },
                    error: function () {
                        alert("Error deleting person. Please try again.");
                    }
                });
            });
        });
    </script>
}
