@model IEnumerable<AquentChallenge.Models.Client>
@Html.AntiForgeryToken()

@{
    ViewData["Title"] = "Index";
    bool showDeleted = Convert.ToBoolean(ViewData["ShowDeleted"]);
    bool clientsExist = Model != null && Model.Any();
}

<h1>All Clients</h1>

<p>
    <a asp-action="Create" class="btn btn-outline-indigo btn-lg px-4">+ Create New</a>
</p>

@if (!clientsExist)
{
    <div class="alert alert-info" role="alert">
        No clients found. Click "Create New" to add a client.
    </div>
}
else
{
<table class="table table-striped table-hover">
    <thead>
        <tr>
            <th>
                @Html.DisplayNameFor(model => model.CompanyName)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Website)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Phone)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Address)
            </th>
            @if (showDeleted)
            {
                <th>@Html.DisplayNameFor(model => model.IsDeleted)</th>
            }
            <th></th>
        </tr>
    </thead>
    <tbody>
    @foreach (var item in Model) {
        <tr>
            <td>
                @Html.DisplayFor(modelItem => item.CompanyName)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Website)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Phone)
            </td>
            <td>
                @Html.DisplayFor(modelItem => item.Address)
            </td>
            @if (showDeleted) { 
                <td>
                    @Html.DisplayFor(modelItem => item.IsDeleted)
                </td>
            }
            <td>
                <div class="btn-group" role="group" aria-label="Actions">
                    <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-pencil"></i> Edit
                    </a>
                    <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-sm btn-outline-info">
                        <i class="bi bi-eye"></i> Details
                    </a>
                    <a href="javascript:void(0)"
                        class="btn btn-sm btn-outline-danger delete-btn"
                        data-id="@item.Id"
                        data-name="@item.CompanyName">
                        <i class="bi bi-trash"></i> Delete
                    </a>
                </div>
            </td>
        </tr>
    }
    </tbody>
</table>
}

@section Scripts {
    <script>
        $(document).ready(function() {
            let deleteId = null;

            $(".delete-btn").click(function () {
                deleteId = $(this).data("id");
                const name = $(this).data("name");
                $("#deleteModal .modal-body").text(`Are you sure you want to delete "${name}"?`);
                $("#deleteModal").modal("show");
            });

            $("#confirmDeleteBtn").click(function () {
                if (!deleteId) return;

                $.ajax({
                    url: `/Clients/Delete/${deleteId}`,
                    type: "POST",
                    data: { __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val() },
                    success: function () {
                        $("#deleteModal").modal("hide");
                        $(`a.delete-btn[data-id='${deleteId}']`).closest("tr").fadeOut(500, function() {
                            $(this).remove();

                            // Check if table is empty now
                            if ($("table tbody tr").length === 0) {
                                // Find the main container so we can put the alert in the right place
                                const container = $("table").closest(".container, .container-fluid, main, section");

                                $("table").remove();

                                container.append(`
                                    <div class="alert alert-info mt-4 text-center" role="alert">
                                        No clients found. Click <strong>"Create New"</strong> to add a client.
                                    </div>
                                `);   
                            }
                        });
                    },
                    error: function () {
                        alert("Error deleting client. Please try again.");
                    }
                });
            });
        });
    </script>
}



